<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Delivery Drivers Log â€“ Ravintola Tandoori Villa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --border: #212a40;
      --red: #ff3b30;
      --gap: 24px;
      --card-radius: 15px;
      --green-dot: #2ecc40;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      box-sizing: border-box;
      width: 100vw;
      font-family: 'Poppins', Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body, .page-wrapper {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .header {
      width: 100%;
      background: var(--card-bg);
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 19px 16px 12px 16px;
      margin: 0 0 var(--gap) 0;
      margin-top: 24px;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 9px rgba(66, 165, 245, 0.08);
      min-height: 43px;
      letter-spacing: 0.03em;
      max-width: 1100px;
      align-self: center;
    }
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.22rem;
      font-weight: 800;
      color: #fff;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 12px #009de044;
      white-space: nowrap;
      flex: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6em;
    }
    .header-desc {
      font-size: 1.08em;
      font-weight: 500;
      color: #bbdefb;
      opacity: 0.88;
      margin-left: 18px;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.01em;
      text-align: center;
      flex: none;
      display: inline-block;
      white-space: normal;
      max-width: 68vw;
    }
    .header-btnbar {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      margin-bottom: 0;
    }
    .header-btnbar button {
      font-size: 1.08em;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 700;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 8px 20px;
      cursor: pointer;
      transition: background 0.16s;
    }
    .header-btnbar button:hover { background: var(--primary-hover);}
    .header-btnbar .logout-btn { background: var(--red);}
    .header-btnbar .logout-btn:hover { background: #c11;}
    .header-btnbar .reports-btn { background: var(--primary);}
    .log-board {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--gap);
      width: 100vw;
      max-width: 1100px;
      align-items: stretch;
      margin: 0 auto 17px auto;
      padding: 0 12px;
      box-sizing: border-box;
      justify-items: center;
      overflow-x: hidden;
    }
    .driver-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: 0 2px 8px rgba(66,165,245,0.08);
      border: 2px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      font-size: 1.09em;
      position: relative;
      margin-top: 16px;
      margin-bottom: 16px;
      word-break: break-word;
      transition: border 0.13s, box-shadow 0.13s;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }
    .driver-card.active {
      border: 2.2px solid var(--primary);
      box-shadow: 0 2px 12px #42a5f52a;
    }
    .driver-card-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 10px 18px 9px 18px;
      background: #0d47a1;
      color: var(--accent);
      font-size: 1.07em;
      font-weight: 700;
      gap: 11px;
      border-bottom: 1px solid var(--border);
      border-top-left-radius: var(--card-radius);
      border-top-right-radius: var(--card-radius);
      box-sizing: border-box;
      flex-wrap: nowrap;
      position: relative;
    }
    .driver-card-header .green-dot {
      display: inline-block;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: var(--green-dot);
      margin-right: 9px;
      vertical-align: middle;
      box-shadow: 0 0 7px 0 var(--green-dot);
    }
    .driver-card-header .driver-name {
      font-size: 1.09em;
      font-weight: 700;
      color: #fff;
      flex: 1 1 auto;
      min-width: 0;
      letter-spacing: 0.04em;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      display: inline-block;
      margin-right: 10px;
    }
    .driver-card-header .driver-date {
      font-size: 1.05em;
      color: #d5f5ff;
      background: #183350;
      border-radius: 0.5em;
      padding: 3px 9px;
      border: none;
      outline: none;
      font-family: inherit;
      font-weight: 600;
      width: 115px;
      min-width: 95px;
      max-width: 140px;
      text-align: center;
      flex-shrink: 0;
      margin-right: 7px;
      position: relative;
      z-index: 1;
      cursor: pointer;
    }
    .driver-card-header .driver-date[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer;}
    .driver-card-header .driver-delete { color: var(--red); font-size: 1.07em; border: none; background: none; cursor: pointer; margin-left: auto; border-radius: 50%; padding: 0.02em 0.22em; transition: background 0.11s; flex-shrink: 0;}
    .driver-fields-row {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 7px;
      margin: 13px 0 3px 0;
      padding: 0 18px;
      justify-content: stretch;
      width: 100%;
      box-sizing: border-box;
    }
    .field-group-row {
      display: flex;
      align-items: center;
      gap: 0.7em;
      width: 100%;
      margin-bottom: 0;
    }
    .field-group-row label {
      font-size: 1em;
      font-weight: 600;
      color: #bbdefb;
      margin-right: 0;
      padding-right: 0;
      font-family: inherit;
      white-space: nowrap;
      min-width: 110px;
    }
    .input-km-wrap {
      display: inline-flex;
      align-items: center;
      border-radius: 7px;
      background: #212a40;
      box-shadow: 0 1px 4px #009de018;
      margin: 0 0.15em;
      padding-left: 0.15em;
      padding-right: 0.2em;
      width: 100%;
    }
    .input-km-wrap input[type="number"], .input-km-wrap input[type="time"] {
      width: 100%;
      min-width: 0;
      max-width: 100%;
      font-size: 1.07em;
      padding: 0.42em 0.12em 0.42em 0.55em;
      background: #212a40;
      border: 1px solid #384164;
      border-radius: 7px;
      color: #fff;
      outline: none;
      text-align: left;
      font-family: inherit;
      font-weight: 700;
      white-space: nowrap;
      box-shadow: none;
      margin-right: 0.06em;
      transition: border 0.18s;
      letter-spacing: 0.01em;
    }
    .input-km-wrap .km-unit {
      font-size: 0.98em;
      color: #7ec5fd;
      margin-left: 0.2em;
      margin-right: 0.3em;
      font-weight: 700;
      white-space: nowrap;
      background: transparent;
      border: none;
      padding: 0;
      pointer-events: none;
      user-select: none;
    }
    .driver-km-result {
      margin: 6px 0 4px 0;
      font-size: 1.13em;
      font-weight: 700;
      color: var(--primary);
      font-family: inherit;
      letter-spacing: 0.04em;
      text-align: left;
      padding: 0 18px;
      min-height: 19px;
      display: flex;
      align-items: center;
      gap: 0.2em;
      width: 100%;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .driver-btns {
      display: flex;
      gap: 0.65em;
      margin-top: 2px;
      padding: 0 18px 10px 18px;
      width: 100%;
      box-sizing: border-box;
    }
    .driver-btns button {
      flex: 1 1 0;
      font-size: 1.12em;
      font-weight: 700;
      border: none;
      border-radius: 9px;
      padding: 0.65em 0;
      background: linear-gradient(90deg,var(--primary),var(--primary-hover));
      color: #fff;
      box-shadow: 0 1px 4px rgba(66,165,245,0.09);
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: background 0.13s;
      min-width: 0;
      font-family: inherit;
      margin: 0;
    }
    .driver-btns button:active { background: var(--primary-hover);}
    .driver-btns .stop-btn { background: linear-gradient(90deg,#ff3b30 30%,#c11 100%); color: #fff; font-family: inherit;}
    .driver-btns .stop-btn:active { background: #ff3b30;}
    .driver-btns .disabled, .driver-btns button:disabled { opacity: 0.5; pointer-events: none;}
    .how-to-use { width: 100vw; max-width: 1050px; margin: 18px auto 0 auto; padding: 13px 14px 11px 14px; background: #161a23cc; border-radius: 10px; color: #bbdefb; font-size: 1.05em; font-family: 'Poppins', Arial, sans-serif; text-align: left; line-height: 1.6; letter-spacing: 0.01em; box-shadow: 0 2px 8px #212a4033; box-sizing: border-box; overflow-x: hidden; align-self: center;}
    @media (max-width: 1100px) { .log-board { max-width: 99vw; } .driver-card { min-width: 0; max-width: 99vw; } }
    @media (max-width: 900px) {
      .log-board { grid-template-columns: 1fr; padding: 0 8px; gap: 16px; }
      .driver-card { min-width: 98vw; max-width: 98vw; font-size: 1.06em; }
      .driver-fields-row {padding:0 8px;}
    }
    @media (max-width: 600px) {
      html, body { font-size: 17px; }
      .log-board { grid-template-columns: 1fr; padding: 0 2px; gap:16px;}
      .driver-card { min-width: 99vw; max-width: 99vw; font-size: 1.04em;}
      .driver-card-header .driver-date { width: 100px; min-width: 80px; max-width: 110px; font-size: 1.02em; }
      .driver-fields-row label { font-size: 1em; min-width: 65px;}
      .input-km-wrap input[type="number"], .input-km-wrap input[type="time"] { font-size: 1em; }
    }
    @media (max-width: 450px) {
      html, body { font-size: 16px; }
      .driver-card-header, .driver-fields-row, .driver-btns, .driver-km-result {padding-left:2px;padding-right:2px;}
      .driver-card { font-size: 1em;}
      .input-km-wrap input[type="number"], .input-km-wrap input[type="time"] { font-size: 1em;}
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="header">
      <div class="header-row">
        <span class="header-title">
          <i class="fas fa-car"></i> Delivery Drivers Log
        </span>
        <span class="header-desc">
          Ravintola Tandoori Villa &nbsp;|&nbsp; Log car drivers' shift kilometers and time daily
        </span>
      </div>
      <div class="header-btnbar">
        <button class="reports-btn" id="showReportsBtn"><i class="fas fa-road"></i> Show KM Reports</button>
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div class="log-board" id="driverBoard"></div>
    <div class="how-to-use" id="howToUse">
      <b>How to use:</b><br>
      1. Enter your shift's Start kilometres and Time In, then press <b>Start</b>.<br>
      2. Enter your End kilometres and Time Out, then press <b>Stop</b>.<br>
      3. See your shift summary and review reports.<br>
      <hr>
      <b>Note:</b> Only the logged-in driver can view and log their own shift.
    </div>
    <div class="modal-bg" id="modalBg">
      <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose" title="Close">&times;</button>
        <div class="modal-title"><i class="fas fa-check-circle" style="color:var(--primary);"></i> Shift Log Saved</div>
        <div class="modal-details" id="modalDetails"></div>
        <button class="modal-done-btn" id="modalDone">Done</button>
      </div>
    </div>
    <div class="modal-bg" id="confirmModalBg">
      <div class="modal-confirm" id="confirmModalContent">
        <div class="modal-confirm-title"><i class="fas fa-exclamation-triangle" style="color:var(--red);"></i> Confirm Delete</div>
        <div class="modal-confirm-details" id="confirmModalDetails"></div>
        <div class="modal-confirm-btns">
          <button class="modal-confirm-btn" id="confirmDeleteBtn">Delete</button>
          <button class="modal-cancel-btn" id="cancelDeleteBtn">Cancel</button>
        </div>
      </div>
    </div>
    <div class="modal-bg" id="logoutModalBg">
      <div class="modal-confirm" id="logoutModalContent">
        <div class="modal-confirm-title"><i class="fas fa-sign-out-alt" style="color:var(--primary);"></i> Confirm Logout</div>
        <div class="modal-confirm-details" id="logoutModalDetails">Are you sure you want to logout?</div>
        <div class="modal-confirm-btns">
          <button class="modal-confirm-btn" id="confirmLogoutBtn">Logout</button>
          <button class="modal-cancel-btn" id="cancelLogoutBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const userData = JSON.parse(localStorage.getItem("user") || "null");
    if (!userData) { window.location.href = "login.html"; }
    const isAdmin = userData.role === "admin";
    const currentUser = userData.name;

    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allUsers = {};
    let driverState = {};

    function showModal(details) {
      document.getElementById('modalDetails').innerHTML = details;
      document.getElementById('modalBg').classList.add('active');
      setTimeout(() => { document.getElementById('modalDone').focus(); }, 100);
    }
    function hideModal() { document.getElementById('modalBg').classList.remove('active'); }
    document.getElementById('modalClose').onclick = hideModal;
    document.getElementById('modalDone').onclick = hideModal;
    document.getElementById('modalBg').onclick = function(e) { if (e.target === document.getElementById('modalBg')) hideModal(); };

    function showConfirmModal(userId, userName) {
      document.getElementById('confirmModalDetails').innerHTML = `Are you sure you want to delete <b>${userName}</b>? This cannot be undone.`;
      document.getElementById('confirmModalBg').classList.add('active');
      pendingDeleteDriverId = userId;
      setTimeout(() => { document.getElementById('confirmDeleteBtn').focus(); }, 100);
    }
    function hideConfirmModal() { document.getElementById('confirmModalBg').classList.remove('active'); pendingDeleteDriverId = null; }
    document.getElementById('cancelDeleteBtn').onclick = hideConfirmModal;
    document.getElementById('confirmModalBg').onclick = function(e) { if (e.target === document.getElementById('confirmModalBg')) hideConfirmModal(); };
    document.getElementById('confirmDeleteBtn').onclick = function() {
      if (pendingDeleteDriverId) {
        db.ref("users/" + pendingDeleteDriverId).remove();
        db.ref("driverStates/" + pendingDeleteDriverId).remove();
        hideConfirmModal();
      }
    };
    let pendingDeleteDriverId = null;

    document.getElementById("showReportsBtn").onclick = () => { window.location.href = "reports.html"; };
    document.getElementById("logoutBtn").onclick = () => { document.getElementById("logoutModalBg").classList.add('active'); setTimeout(() => { document.getElementById("confirmLogoutBtn").focus(); }, 100);}
    document.getElementById("cancelLogoutBtn").onclick = () => { document.getElementById("logoutModalBg").classList.remove('active'); };
    document.getElementById("logoutModalBg").onclick = function(e) { if (e.target === document.getElementById("logoutModalBg")) document.getElementById("logoutModalBg").classList.remove('active'); };
    document.getElementById("confirmLogoutBtn").onclick = function() { localStorage.removeItem('user'); window.location.href = "login.html"; };

    db.ref("users").on("value", snap => {
      allUsers = snap.val() || {};
      renderDrivers();
    });

    db.ref("driverStates").on("value", snap => {
      const states = snap.val() || {};
      Object.entries(states).forEach(([userId, state]) => {
        if (!driverState[userId]) driverState[userId] = {};
        Object.assign(driverState[userId], state);
      });
      renderDrivers();
    });

    function updateDriverState(userId) {
      db.ref("driverStates/" + userId).set(driverState[userId]);
    }

    function pad2(n){return String(n).padStart(2,'0');}
    function toDisplayDate(isoStr) {
      if (!isoStr) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y, m, d] = isoStr.split('-');
      const mIndex = parseInt(m,10)-1;
      return `${pad2(d)}/${months[mIndex]}/${y}`;
    }

    function renderDrivers() {
      const driverBoard = document.getElementById('driverBoard');
      driverBoard.innerHTML = "";
      Object.entries(allUsers).forEach(([userId, userObj]) => {
        if (!driverState[userId]) driverState[userId] = {
          kmIn: "",
          kmOut: "",
          timeIn: "",
          timeOut: "",
          running: false,
          date: (new Date()).toISOString().slice(0,10),
          stopped: false
        };
        const s = driverState[userId];
        const card = document.createElement('div');
        card.className = 'driver-card' + (s.running ? ' active' : '');
        const headerRow = document.createElement('div');
        headerRow.className = 'driver-card-header';

        if (s.running) {
          const dot = document.createElement('span');
          dot.className = 'green-dot';
          headerRow.appendChild(dot);
        }
        const nameEl = document.createElement('span');
        nameEl.className = 'driver-name';
        nameEl.textContent = userObj.name;
        const dateEl = document.createElement('input');
        dateEl.type = 'date';
        dateEl.className = 'driver-date';
        dateEl.value = s.date;
        dateEl.maxLength = 10;
        dateEl.disabled = s.running;
        dateEl.onfocus = function() {
          dateEl.disabled = false;
        };
        dateEl.onblur = function() {
          dateEl.disabled = s.running;
        };
        dateEl.onchange = e => {
          const val = e.target.value.trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
            s.date = val;
            updateDriverState(userId);
            renderDrivers();
          } else {
            e.target.value = s.date;
          }
        };
        dateEl.onclick = function(e) { 
          if(dateEl.disabled) {
            dateEl.disabled = false;
            setTimeout(() => { 
              dateEl.showPicker && dateEl.showPicker(); 
            }, 10);
          } else {
            dateEl.showPicker && dateEl.showPicker();
          } 
        };
        dateEl.onkeyup = function(e) {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(dateEl.value)) {
            dateEl.value = s.date;
          }
        };
        if (isAdmin) {
          const delBtn = document.createElement('button');
          delBtn.className = 'driver-delete';
          delBtn.title = "Remove driver";
          delBtn.innerHTML = "<i class='fas fa-trash'></i>";
          delBtn.onclick = () => showConfirmModal(userId, userObj.name);
          headerRow.appendChild(nameEl);
          headerRow.appendChild(dateEl);
          headerRow.appendChild(delBtn);
        } else {
          headerRow.appendChild(nameEl);
          headerRow.appendChild(dateEl);
        }
        card.appendChild(headerRow);

        const fieldsRow = document.createElement('div');
        fieldsRow.className = 'driver-fields-row';

        // First row: Start/End kilometres
        const row1 = document.createElement('div');
        row1.className = 'field-group-row';
        const kmInLbl = document.createElement('label');
        kmInLbl.textContent = "Start kilometres";
        const kmInWrap = document.createElement('span');
        kmInWrap.className = 'input-km-wrap';
        const kmIn = document.createElement('input');
        kmIn.type = 'number';
        kmIn.placeholder = 'Start kilometres';
        kmIn.value = s.kmIn;
        kmIn.disabled = s.running;
        kmIn.min = "1";
        kmIn.max = "999999999";
        kmIn.onfocus = function() { kmIn.disabled = false; };
        kmIn.onblur = function(e) {
          kmIn.disabled = s.running;
          if (e.target.value.length < 1 || e.target.value.length > 9) return;
          s.kmIn = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        kmIn.oninput = function(e) {
          s.kmIn = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        row1.appendChild(kmInLbl);
        row1.appendChild(kmInWrap);
        kmInWrap.appendChild(kmIn);

        const kmOutLbl = document.createElement('label');
        kmOutLbl.textContent = "End kilometres";
        const kmOutWrap = document.createElement('span');
        kmOutWrap.className = 'input-km-wrap';
        const kmOut = document.createElement('input');
        kmOut.type = 'number';
        kmOut.placeholder = 'End kilometres';
        kmOut.value = s.kmOut;
        kmOut.disabled = !s.running;
        kmOut.min = "1";
        kmOut.max = "999999999";
        kmOut.onfocus = function() { kmOut.disabled = false; };
        kmOut.onblur = function(e) {
          kmOut.disabled = !s.running;
          if (e.target.value.length < 1 || e.target.value.length > 9) return;
          s.kmOut = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        kmOut.oninput = function(e) {
          s.kmOut = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        row1.appendChild(kmOutLbl);
        row1.appendChild(kmOutWrap);
        kmOutWrap.appendChild(kmOut);

        fieldsRow.appendChild(row1);

        // Second row: Time In and Time Out (below, full width)
        const row2 = document.createElement('div');
        row2.className = 'field-group-row';
        row2.style.marginTop = "2px";
        const timeInLbl = document.createElement('label');
        timeInLbl.textContent = "Time In";
        const timeInWrap = document.createElement('span');
        timeInWrap.className = 'input-km-wrap';
        const timeIn = document.createElement('input');
        timeIn.type = 'time';
        timeIn.value = s.timeIn;
        timeIn.disabled = s.running;
        timeIn.onchange = function(e) {
          s.timeIn = e.target.value;
          updateDriverState(userId);
        };
        row2.appendChild(timeInLbl);
        row2.appendChild(timeInWrap);
        timeInWrap
